@model IEnumerable<DuAnTotNghiep.Models.SanPhamChiTiet>

@{
    ViewData["Title"] = "POS - Bán hàng tại quầy";
}

<h2 class="text-center">POS - Bán hàng tại quầy</h2>

<input type="text" id="searchProductInput" class="form-control mb-3" placeholder="Tìm sản phẩm theo tên..." />
<ul id="productList" class="list-group mb-4"></ul>

<h4>Giỏ hàng</h4>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Tên sản phẩm</th>
            <th>Giá</th>
            <th>Số lượng</th>
            <th>Thành tiền</th>
            <th>Thao tác</th>
        </tr>
    </thead>
    <tbody id="cartItemsTable"></tbody>
</table>
<div class="text-end fw-bold">Tổng tiền: <span id="totalAmount">0</span> đ</div>

<button id="checkoutBtn" class="btn btn-success w-100 mt-3">Xác nhận bán hàng</button>

@section Scripts {
    <script>
        let cartItems = [];

        $(document).ready(function () {
            $('#searchProductInput').on('input', function () {
                const keyword = $(this).val();
                if (keyword.length >= 2) {
                    $.get('/Admin/HoaDon/SearchProduct', { keyword: keyword }, function (data) {
                        let html = '';
                        data.forEach(item => {
                            html += `<li class='list-group-item'>${item.name} - ${item.price.toLocaleString()} đ (Còn: ${item.stock}) <button class='btn btn-sm btn-primary float-end' onclick="addToCart('${item.id}','${item.name}',${item.price})">Thêm</button></li>`;
                        });
                        $('#productList').html(html);
                    });
                } else {
                    $('#productList').html('');
                }
            });
        });

        function addToCart(id, name, price) {
            const item = cartItems.find(x => x.id === id);
            if (item) {
                item.quantity += 1;
            } else {
                cartItems.push({ id, name, price, quantity: 1 });
            }
            renderCart();
        }

        function renderCart() {
            let html = '';
            let total = 0;
            cartItems.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                html += `<tr>
                            <td>${item.name}</td>
                            <td>${item.price.toLocaleString()} đ</td>
                            <td><input type='number' min='1' value='${item.quantity}' onchange='updateQuantity(${index}, this.value)' class='form-control form-control-sm' /></td>
                            <td>${itemTotal.toLocaleString()} đ</td>
                            <td><button class='btn btn-sm btn-danger' onclick='removeFromCart(${index})'>Xóa</button></td>
                        </tr>`;
            });
            $('#cartItemsTable').html(html);
            $('#totalAmount').text(total.toLocaleString());
        }

        function updateQuantity(index, newQuantity) {
            cartItems[index].quantity = parseInt(newQuantity);
            renderCart();
        }

        function removeFromCart(index) {
            cartItems.splice(index, 1);
            renderCart();
        }

        $('#checkoutBtn').click(function () {
            if (cartItems.length === 0) {
                alert('Giỏ hàng đang trống.');
                return;
            }

            const model = {
                CartItems: cartItems.map(item => ({ ProductDetailId: item.id, Quantity: item.quantity })),
                CustomerPhone: '0987654321',
                CustomerName: 'Khách lẻ',
                CustomerEmail: 'khachle@example.com',
                ShippingAddress: 'Tại quầy',
                PaymentMethod: 'Tiền mặt',
                ShippingFee: 0,
                Discount: 0,
                Note: 'Bán tại quầy'
            };

            $.ajax({
                type: 'POST',
                url: '/Admin/HoaDon/Create',
                data: JSON.stringify(model),
                contentType: 'application/json',
                success: function (res) {
                    if (res.success) {
                        alert(res.message);
                        cartItems = [];
                        renderCart();
                    } else {
                        alert(res.message);
                    }
                },
                error: function () {
                    alert('Đã xảy ra lỗi, vui lòng thử lại.');
                }
            });
        });
    </script>
}
